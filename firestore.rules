
/**
 * @file Firestore Security Rules for Personalized Learning Nexus.
 *
 * Core Philosophy:
 * This ruleset enforces a strict user-ownership model for all personal data, including quizzes, study plans, summaries, and quiz attempts.
 * Learning materials remain publicly readable to facilitate discovery.
 *
 * Data Structure:
 * - /users/{userId}: User profiles, accessible only by the user themselves.
 * - /users/{userId}/quizzes/{quizId}: Quizzes owned by a specific user.
 * - /users/{userId}/studyPlans/{studyPlanId}: Study plans owned by a specific user.
 * - /users/{userId}/summaries/{summaryId}: Content summaries owned by a specific user.
 * - /users/{userId}/quizAttempts/{quizAttemptId}: User's quiz attempts, only accessible by the user themselves.
 * - /learningMaterials/{learningMaterialId}: Learning materials, publicly readable but only editable by the owner.
 *
 * Key Security Decisions:
 * - All user-generated content is stored in subcollections under `/users/{userId}` to leverage path-based security. This is more robust and scalable than query-based rules.
 * - Learning materials are publicly readable to facilitate discovery.
 * - The structure ensures a homogeneous security posture within subcollections, enhancing debuggability.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * @description Controls access to user profiles and all their subcollections.
     * @path /users/{userId}
     * @allow (get, update, delete) - User can manage their own profile.
     * @allow (create) - User can create their own profile.
     * @deny (list) - Disallows listing all users.
     * @principle Enforces document ownership for all operations on a user's own data.
     */
    match /users/{userId} {
      function isOwner() {
        return request.auth != null && request.auth.uid == userId;
      }

      allow get, update, delete: if isOwner();
      allow create: if isOwner() && request.resource.data.id == userId;
      allow list: if false; // User listing is not permitted.

      /**
       * @description Controls access to quizzes for a specific user.
       * @path /users/{userId}/quizzes/{quizId}
       * @allow (read, write) - The owner of the user profile can fully manage their own quizzes.
       * @principle Path-based security. Access is inherited from the parent user document rule.
       */
      match /quizzes/{quizId} {
        allow read, write: if isOwner();
      }
      
      /**
       * @description Controls access to study plans for a specific user.
       * @path /users/{userId}/studyPlans/{studyPlanId}
       * @allow (read, write) - The owner of the user profile can fully manage their own study plans.
       * @principle Path-based security.
       */
      match /studyPlans/{studyPlanId} {
        allow read, write: if isOwner();
      }
      
      /**
       * @description Controls access to content summaries for a specific user.
       * @path /users/{userId}/summaries/{summaryId}
       * @allow (read, write) - The owner of the user profile can fully manage their own summaries.
       * @principle Path-based security.
       */
      match /summaries/{summaryId} {
        allow read, write: if isOwner();
      }
      
      /**
       * @description Controls access to quiz attempts for a specific user.
       * @path /users/{userId}/quizAttempts/{quizAttemptId}
       * @allow (read, write) - The owner of the user profile can fully manage their own quiz attempts.
       * @principle Path-based security.
       */
      match /quizAttempts/{quizAttemptId} {
        allow read, write: if isOwner();
      }
    }

    /**
     * @description Controls access to learning materials.
     * @path /learningMaterials/{learningMaterialId}
     * @allow (get, list) - Any user can read learning materials.
     * @allow (create, update, delete) - Only the creator can manage the material.
     * @principle Allows public read access but restricts write access to the owner (creator).
     */
    match /learningMaterials/{learningMaterialId} {
      function isCreator() {
        return request.auth != null && resource.data.creatorId == request.auth.uid;
      }
      allow read: if true;

      allow create: if request.auth != null && request.resource.data.creatorId == request.auth.uid;
      allow update, delete: if isCreator();
    }
  }
}
